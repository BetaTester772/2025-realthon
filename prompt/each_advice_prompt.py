"""
개별 과목 학습 조언 생성 프롬프트 테스트 모듈.

이 모듈은 OpenAI API를 사용하여 특정 과목의 수강평을 분석하고
목표 성적 달성을 위한 학습 전략 조언을 생성합니다.

분석 내용:
    - 과제 난이도 (1-5 척도)
    - 시험 난이도 (1-5 척도)
    - 시험/과제 공통 언급 사항 요약
    - 목표 성적에 따른 학습 전략 조언

난이도 척도:
    1: 매우 쉬움
    2: 쉬움
    3: 보통
    4: 어려움
    5: 매우 어려움

사용법:
    python prompt/each_advice_prompt.py

환경 변수:
    OPENAI_API_KEY: OpenAI API 키 (필수)
"""

from openai import OpenAI
import os
from dotenv import load_dotenv
import pandas as pd
from pydantic import BaseModel, Field  # Pydantic 스키마 정의용 (미사용)

# 환경 변수 로드 (.env 파일에서 OPENAI_API_KEY 읽기)
load_dotenv()

# =============================================================================
# OpenAI 클라이언트 초기화
# =============================================================================
api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=api_key)

# =============================================================================
# 수강평 데이터 로드
# =============================================================================
# COSE341(운영체제) 과목의 수강평 CSV 파일 로드
df = pd.read_csv("../crawling/cose341_klue_reviews.csv")
reviews = df["review"].tolist()

# =============================================================================
# 수강평 데이터 전처리
# =============================================================================
# 수강평 데이터를 딕셔너리 형태로 변환
course_reviews = []

for review in reviews:
    course_reviews.append(
            {
                    "course_id" : 1,                        # 과목 ID (고정값)
                    "content"   : review,                   # 수강평 본문
                    "generosity": 0,                        # 채점 관대함 (미사용)
                    "id"        : len(course_reviews) + 1   # 순차적 ID
            }
    )

# 수강평 내용만 추출하여 줄바꿈으로 연결
course_reviews_str = "\n".join([f"{review['content']}" for review in course_reviews])

# 목표 성적 설정
objective_grade = "B+"

# =============================================================================
# OpenAI API 호출
# =============================================================================
# GPT 모델에 수강평과 목표 성적을 전달하여 학습 조언 생성
response = client.responses.create(
        model="gpt-5-mini",
        input=f"""
    목표성적: {objective_grade}
    이건 이전 수강자들의 강의평 입니다. 각 강의평은 과목 ID와 함께 주어집니다.
    강의평에서 과제의 난이도와 관련한 정보를 추출해서 난이도를 정수형으로 추출해서 반환해주세요.
    강의평에서 시험의 난이도와 관련한 정보를 추출해서 난이도를 정수형으로 추출해서 반환해주세요.
    난이도는 1부터 5까지의 정수로 추출해주세요.
    1: 매우 쉬움
    2: 쉬움
    3: 보통
    4: 어려움
    5: 매우 어려움
    시험과 과제와 관련해 공통된 언급들은 정리해서 1-2문장으로 정리해주세요. 
    정리한 내용을 바탕으로 각 과제와 시험 중 어느 곳에 집중해야 할지 1-2문장으로 정리해서 조언형식으로 반환해주세요. 
    이 때 조언에는 과제와 시험 난이도 특성을 근거로 각 과제와 시험 중 어느 곳에 집중해야 할지 정리해주세요.
    조언에는 목표성적에 따라 각 과제와 시험 중 어느 곳에 집중해야 할지 정리해주세요.
    만약 하지 않아도 되는 과제가 있다면 그 과제는 하지 않아도 된다고 정리해주세요. 
    만약 그런 과제가 없다면 이 부분은 언급하지 말아주세요.
    각 과제의 성적 비중이 어느 정도인지에 따라 각 과제와 시험 중 어느 곳에 집중해야 할지 정리해주세요.
    비중이 크고 작은 것을 판단할 때에는 강의평에 언급된 경우에 대한 내용을 참고해주세요.
    {course_reviews_str}
    """,
        text={
                "verbosity": "low",
        },
        reasoning={"effort": "low"},
)

print(response.output_text)
